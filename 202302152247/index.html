<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Fang Li - vjvm note 02： Parser</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https://ffangli.github.io/site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Fang Li</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;ffangli.github.io">
                            主页
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;ffangli.github.io&#x2F;categories">
                            分类
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;ffangli.github.io&#x2F;tags">
                            标签
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.com&#x2F;ffangli">
                            GitHub
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;ffangli.github.io">Fang Li</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;ffangli.github.io">
                                    主页
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;ffangli.github.io&#x2F;categories">
                                    分类
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;ffangli.github.io&#x2F;tags">
                                    标签
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.com&#x2F;ffangli">
                                    GitHub
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://ffangli.github.io/202302152247/#class-wen-jian-jie-gou" class="toc-link">class 文件结构</a>
                    
                </li>
                
                <li>
                    <a href="https://ffangli.github.io/202302152247/#duo-xing-qiu-zhi-he-ji-zao-qiu-zhi" class="toc-link">惰性求值和及早求值</a>
                    
                </li>
                
                <li>
                    <a href="https://ffangli.github.io/202302152247/#dai-ma" class="toc-link">代码</a>
                    
                </li>
                
                <li>
                    <a href="https://ffangli.github.io/202302152247/#can-kao-wen-xian" class="toc-link">参考文献</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;ffangli.github.io&#x2F;202302152247&#x2F;">vjvm note 02： Parser</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2023-02-15</span>
            
        </div>
    </header>

    <div class="post-content">
      <span id="continue-reading"></span><h2 id="class-wen-jian-jie-gou">class 文件结构</h2>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>ClassFile {
</span><span>  u4              magic;
</span><span>  u2              minor_version;
</span><span>  u2              major_version;
</span><span>  u2              constant_pool_count;
</span><span>  cp_info         constant_pool[constant_pool_count - </span><span style="color:#d08770;">1</span><span>]; </span><span style="color:#65737e;">// 常量池
</span><span>  u2              access_flags;
</span><span>  u2              this_class;
</span><span>  u2              super_class;
</span><span>  u2              interfaces_count;
</span><span>  u2              interfaces[interfaces_count]; </span><span style="color:#65737e;">// 类实现的接口
</span><span>  u2              fields_count;
</span><span>  field_info      fields[fields_count]; </span><span style="color:#65737e;">// 类的成员变量
</span><span>  u2              methods_count;
</span><span>  method_info     methods[methods_count]; </span><span style="color:#65737e;">// 类的方法
</span><span>  u2              attributes_count;
</span><span>  attribute_info  attributes[attributes_count];
</span><span>};
</span></code></pre>
<p>每一行的前一列是类型，后一列是名称。例如，<code>u4 magic</code> 代表 <code>magic</code> 为 32 位无符号整形。在一个 class 文件中，最重要的四个结构是常量池（Constant Pool）、 成员变量（Field）、方法（Method）和属性（Attribute）。</p>
<ul>
<li>常量池（Constant Pool）这里的 <code>info</code> 成员的长度是可变的。</li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>cp_info {
</span><span>  u1  tag; </span><span style="color:#65737e;">// 常量类型
</span><span>  u1  info[]; </span><span style="color:#65737e;">// 常量数据
</span><span>};
</span></code></pre>
<p>比如，对于 <code>CONSTANT_Class_info</code>：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>struct CONSTANT_Class_info {
</span><span>  u1  tag;
</span><span>  u2  name_index;
</span><span>};
</span></code></pre>
<p>这里的 <code>info</code> 就被替换成了两个字节的索引，指向常量池中代表这个类名称的项。</p>
<ul>
<li>成员变量（Field） 其中的 <code>name_index</code> 和 <code>descriptor_index</code> 都指向常量池的内容。</li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>field_info {
</span><span> u2 access_flags;
</span><span> u2 name_index;
</span><span> u2 descriptor_index;
</span><span> u2 attributes_count;
</span><span> attribute_info attributes[attributes_count];
</span><span>}
</span></code></pre>
<ul>
<li>方法（Method）</li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>method_info {
</span><span> u2 access_flags;
</span><span> u2 name_index;
</span><span> u2 descriptor_index;
</span><span> u2 attributes_count;
</span><span> attribute_info attributes[attributes_count];
</span><span>}
</span></code></pre>
<ul>
<li>属性（Attribute）属性在类、成员变量和方法的结构中出现，一个属性的通用结构如下：</li>
</ul>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>attribute_info {
</span><span> u2 attribute_name_index;
</span><span> u4 attribute_length;
</span><span> u1 info[attribute_length];
</span><span>}
</span></code></pre>
<p>属性中保存了许多内容，如 <code>static final</code> 变量的值、方法的代码、异常处理所需的信息等。</p>
<h2 id="duo-xing-qiu-zhi-he-ji-zao-qiu-zhi">惰性求值和及早求值</h2>
<p>惰性求值（Lazy Evaluation）在需要时才进行计算</p>
<p>及早求值  (Eager Evaluation) 在构造时就把全部值计算出来</p>
<h2 id="dai-ma">代码</h2>
<p><a href="https://github.com/ffangli/toyjvm">ffangli/toyjvm (github.com)</a></p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> tree src/main/java/vjvm/classfiledefs
</span><span style="color:#bf616a;">$</span><span> tree src/main/java/vjvm/runtime/classdata
</span></code></pre>
<h2 id="can-kao-wen-xian">参考文献</h2>
<p><a href="https://docs.oracle.com/javase/specs/jvms/se8/jvms8.pdf">The Java® Virtual Machine Specification (oracle.com)</a></p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://ffangli.github.io/tags/vjvm/">#vjvm</a>
                    
                </div>
            
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://ffangli.github.io/even.js" ></script>
      
    </body>

</html>
